<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- EmailJS Library -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script type="text/javascript">
    (function() {
      emailjs.init({
        publicKey: "LKnJvFcvSslYggCly",
      });
    })();
  </script>
  
  <title>Festify - User Profile</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="editprofile.css" />
  <link rel="stylesheet" href="footer.css" />
  <link rel="stylesheet" href="navbar.css" />

  <!-- QR Code Generator Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>

  <!-- Import Firebase as a module -->
  <script type="module" src="firebase.js"></script>
  
  <!-- Google Places API with better error handling -->
  <script>
    // Define a global callback that will be called when the API loads
    window.initGoogleMapsAPI = function() {
      console.log('Google Maps API loaded successfully');
      initializeAutocomplete('address1');
    };
    
    // Function to load the Google Maps API with proper key
    async function loadGoogleMapsAPI() {
      // Check if API is already loaded
      if (window.google && window.google.maps) {
        console.log('Google Maps API already loaded');
        initializeAutocomplete('address1');
        return;
      }
      
      try {
        // Get Google Maps API key from Firebase via localStorage
        const googleMapsApiKey = localStorage.getItem('festify_google_maps_api_key') || 'YOUR_FALLBACK_API_KEY';
        console.log('Using Google Maps API key from storage');
        
        // Create the script element
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=' + 
                    googleMapsApiKey + 
                    '&libraries=places&callback=initGoogleMapsAPI';
        script.async = true;
        script.defer = true;
        
        // Add error handling
        script.onerror = function() {
          console.error('Failed to load Google Maps API');
          document.getElementById('address1').placeholder = 'Enter your address manually (API failed to load)';
        };
        
        // Append to document
        document.head.appendChild(script);
      } catch (error) {
        console.error('Error loading Google Maps API:', error);
      }
    }
    
    // Load the API when the document is ready
    document.addEventListener('DOMContentLoaded', function() {
      // Attempt to fetch the API key from Firebase first
      import('./firebase.js').then(module => {
        module.getApiKey('GOOGLE_MAPS_API_KEY').then(apiKey => {
          if (apiKey) {
            console.log('Successfully got Google Maps API key from Firebase');
            localStorage.setItem('festify_google_maps_api_key', apiKey);
          }
          loadGoogleMapsAPI();
        }).catch(error => {
          console.error('Error getting Google Maps API key:', error);
          loadGoogleMapsAPI();
        });
      }).catch(error => {
        console.error('Error importing Firebase module:', error);
        loadGoogleMapsAPI();
      });
      
      // Add a focus event listener to ensure API is loaded when the fields are focused
      const addressField = document.getElementById('address1');
      if (addressField) {
        addressField.addEventListener('focus', function() {
          if (!window.google || !window.google.maps) {
            console.log('Google Maps API not loaded yet, trying to load on focus');
            loadGoogleMapsAPI();
          }
        });
      }
    });
  </script>

  <style>
    /* Dropdown Styles */
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropbtn {
      color: rgb(224, 224, 224);
      background: rgba(255, 255, 255, 0.05);
      padding: 8px 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #0f172a;
      min-width: 160px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      z-index: 1;
    }
    .dropdown-content a {
      color: rgb(224, 224, 224);
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: background 0.3s ease;
    }
    .dropdown-content a:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .dropdown:hover .dropdown-content {
      display: block;
    }
    .dropdown:hover .dropbtn {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
      transform: translateY(-2px);
    }
    /* Ensure the hidden class works as expected */
    .hidden { display: none; }
    
    /* Google Places Autocomplete Styles */
    .pac-container {
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      margin-top: 5px;
      font-family: inherit;
      border: 1px solid #ddd;
      z-index: 9999;
    }
    
    .pac-item {
      padding: 10px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .pac-item:hover {
      background-color: #f5f5f5;
    }
    
    .pac-item-selected {
      background-color: #f0f0f0;
    }
    
    .pac-icon {
      margin-right: 10px;
    }
    
    .pac-item-query {
      font-size: 14px;
      color: #333;
    }
    
    /* Style the input field when focused */
    #address1:focus {
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
      outline: none;
    }
    
    /* Spinner for loading indicator */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-top-color: #4285f4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .form-group {
      position: relative;
    }

    /* Enhanced Profile Form Styles */
    #editProfile .container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 2rem;
      background: rgba(15, 23, 42, 0.8);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .form-section {
      margin-bottom: 2.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .form-section:last-child {
      border-bottom: none;
      margin-bottom: 1.5rem;
    }

    .form-section h2 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: #fff;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .section-subtitle {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      font-style: italic;
    }

    .form-row {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      flex: 1;
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
      font-size: 0.95rem;
    }

    .text-input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .text-input:focus {
      border-color: #4facfe;
      box-shadow: 0 0 0 2px rgba(79, 172, 254, 0.3);
      outline: none;
      background: rgba(255, 255, 255, 0.1);
    }

    .text-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .submit-btn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: block;
      margin: 2rem auto 0;
      width: 100%;
      max-width: 300px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
    }

    .submit-btn:active {
      transform: translateY(-1px);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      #editProfile .container {
        padding: 1.5rem;
        margin: 1rem;
      }
    }

    /* Add a subtle animation for form sections */
    .form-section {
      transition: all 0.3s ease;
    }

    .form-section:hover {
      transform: translateY(-5px);
    }

    /* Required field indicator */
    label[for="address1"]::after,
    label[for="city"]::after,
    label[for="pincode"]::after,
    label[for="state"]::after {
      content: " *";
      color: #4facfe;
    }
    
    /* Profile Header Styles */
    .profile-header {
      display: flex;
      align-items: center;
      padding: 2rem;
      max-width: 900px;
      margin: 2rem auto 0;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(23, 37, 84, 0.8) 100%);
      border-radius: 16px 16px 0 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-bottom: none;
    }
    
    .profile-avatar {
      margin-right: 2rem;
    }
    
    .avatar-circle {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(79, 172, 254, 0.3);
    }
    
    .avatar-initials {
      color: white;
      font-size: 2rem;
      font-weight: bold;
    }
    
    .profile-welcome h1 {
      color: white;
      font-size: 1.8rem;
      margin: 0 0 0.5rem 0;
      font-weight: 600;
    }
    
    .profile-welcome p {
      color: rgba(255, 255, 255, 0.7);
      margin: 0;
      font-size: 1rem;
    }
    
    /* Connect profile header with container */
    #editProfile .container {
      border-radius: 0 0 16px 16px;
      margin-top: 0;
    }
    
    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
        padding: 1.5rem;
        margin: 1rem 1rem 0;
      }
      
      .profile-avatar {
        margin-right: 0;
        margin-bottom: 1rem;
      }
    }

    /* Add Tickets Styles */
    .tickets-header {
      max-width: 900px;
      margin: 2rem auto 1rem;
      padding: 1.5rem 2rem;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      color: #333;
    }
    
    .tickets-header h2 {
      color: #333;
      font-size: 1.8rem;
      margin: 0 0 0.5rem 0;
      font-weight: 600;
    }
    
    .tickets-header p {
      color: #666;
      margin: 0;
      font-size: 1rem;
    }
    
    .tickets-container {
      max-width: 900px;
      margin: 0 auto 2rem;
      padding: 1.5rem 2rem;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .tickets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .ticket-card {
      background: rgba(30, 41, 59, 0.9);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .ticket-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }
    
    .ticket-image {
      height: 160px;
      width: 100%;
      object-fit: cover;
    }
    
    .ticket-content {
      padding: 1.5rem;
    }
    
    .ticket-title {
      font-size: 1.25rem;
      color: white;
      margin: 0 0 0.75rem 0;
      font-weight: 600;
    }
    
    .ticket-info {
      display: flex;
      align-items: center;
      margin-bottom: 0.75rem;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
    }
    
    .ticket-info svg {
      margin-right: 0.5rem;
      opacity: 0.8;
      stroke-width: 2;
      width: 16px;
      height: 16px;
    }
    
    .ticket-details {
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .ticket-quantity {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 0.5rem;
    }
    
    .ticket-price {
      font-weight: 600;
      font-size: 1.1rem;
      color: white;
      margin-top: 0.75rem;
      text-align: right;
    }
    
    .ticket-price::before {
      content: 'Total Cost: ';
      font-weight: normal;
      opacity: 0.8;
    }
    
    .browse-events-btn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 1rem;
    }
    
    .browse-events-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
    }

    /* Specific styling for the tickets tab */
    #tickets {
      background-color: white;
    }
    
    body.tickets-view {
      background-color: white;
    }

    /* QR Code Styles */
    .ticket-qr-code {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .ticket-qr-code h4 {
      font-size: 1rem;
      color: white;
      margin-bottom: 0.75rem;
    }

    .qr-code-image {
      max-width: 150px;
      background: white;
      padding: 8px;
      border-radius: 8px;
      margin: 0 auto;
      display: block;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .qr-instructions {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 0.5rem;
      font-style: italic;
    }

    /* Improved ticket card styles */
    .ticket-card {
      background: rgba(30, 41, 59, 0.9);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="top-nav">
    <div class="top-nav-container">
      <a href="javascript:location.reload();" class="logo">
        <img src="images/festifyLogo.png" alt="Festify" />
      </a>
      <div class="nav-links" style="display: flex; justify-content: flex-end; flex-grow: 1;">
        <a href="#" class="nav-item" onclick="showSection('FindEvent')">Find an Event</a>
      </div>
      <div class="nav-actions" style="display: flex; justify-content: flex-end;">
        <a href="list-your-event.html" class="nav-item">List your Event</a>
        <div class="dropdown">
          <button class="icon-button">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
              <circle cx="12" cy="7" r="4" />
            </svg>
          </button>
          <div class="dropdown-content">
            <a href="#" onclick="showSection('editProfile')">Edit Profile</a>
            <a href="#" onclick="showSection('tickets')">Tickets</a>
            <a href="#" id="navSignOutBtn" onclick="signOutUser()">Sign Out</a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content Sections -->
  <div id="editProfile" class="tab-content" style="display: none;">
    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-avatar">
        <div class="avatar-circle">
          <span class="avatar-initials" id="userInitials">U</span>
        </div>
      </div>
      <div class="profile-welcome">
        <h1>Welcome, <span id="welcomeUserName">User</span></h1>
        <p>Manage your profile information and Delivery Details</p>
      </div>
    </div>
    
    <div class="container">
      <form id="profileForm" autocomplete="off">
        <!-- Personal Details -->
        <div class="form-section">
          <h2>Personal Details</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input type="text" id="firstName" placeholder="Enter first name" class="text-input" autocomplete="on" pattern="[A-Za-z ]+" title="Please enter letters only" />
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input type="text" id="lastName" placeholder="Enter last name" class="text-input" autocomplete="on" pattern="[A-Za-z ]+" title="Please enter letters only" />
            </div>
          </div>
          <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" placeholder="Enter phone number" class="text-input" autocomplete="on" maxlength="10" pattern="[0-9]{10}" title="Please enter exactly 10 digits" />
          </div>
        </div>

        <!-- Delivery Details -->
        <div class="form-section">
          <h2>Delivery Details</h2>
          <p class="section-subtitle">These details will be used for physical tickets</p>
          <div class="form-group">
            <label for="address1">Address 1</label>
            <input type="text" id="address1" required class="text-input" placeholder="Start typing your address to search..." autocomplete="off" />
          </div>
          <div class="form-group">
            <label for="address2">Address 2</label>
            <input type="text" id="address2" class="text-input" autocomplete="on" />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="landmark">Landmark</label>
              <input type="text" id="landmark" class="text-input" autocomplete="on" />
            </div>
            <div class="form-group">
              <label for="city">City</label>
              <input type="text" id="city" required class="text-input" autocomplete="on" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="pincode">Pincode</label>
              <input type="text" id="pincode" required class="text-input" autocomplete="on" />
            </div>
            <div class="form-group">
              <label for="state">Province</label>
              <input type="text" id="state" required class="text-input" autocomplete="on" />
            </div>
          </div>
        </div>

        <button type="submit" class="submit-btn">UPDATE</button>
      </form>
    </div>
  </div>

  <div id="FindEvent" class="tab-content" style="display: none;">
    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-container">
        <h1>Discover Amazing Events</h1>
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="Search events..." class="search-input" />
        </div>
      </div>
    </section>
    <!-- Events Grid -->
    <section class="events-section">
      <div class="container2">
        <div class="promo-slider">
          <div class="promo-header">
            <h3>üéâ Special Promo Codes</h3>
            <p>Use these codes at checkout for amazing discounts!</p>
          </div>
          <div class="promo-slides">
            <div class="promo-slide">
              <div class="promo-content">
                <span class="promo-code">WELCOME20</span>
                <span class="promo-desc">20% off first purchase</span>
                <span class="promo-valid">Valid until Dec 31, 2024</span>
              </div>
            </div>
            <div class="promo-slide">
              <div class="promo-content">
                <span class="promo-code">FESTIVAL15</span>
                <span class="promo-desc">15% off festival tickets</span>
                <span class="promo-valid">Valid until Dec 31, 2024</span>
              </div>
            </div>
          </div>
          <div class="promo-dots">
            <span class="dot active"></span>
            <span class="dot"></span>
          </div>
        </div>
        <div class="events-grid" id="eventsGrid">
          <!-- Event cards will be injected here by app.js -->
        </div>
      </div>
    </section>
  </div>

  <div id="tickets" class="tab-content" style="display: none;">
    <div class="tickets-header">
      <h2>My Tickets</h2>
      <p>View and manage your purchased tickets</p>
    </div>
    
    <div class="tickets-container">
      <div id="ticketsLoading" style="text-align: center; padding: 2rem;">
        <div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 2px solid rgba(0, 0, 0, 0.1); border-top-color: #4facfe;"></div>
        <p style="color: #555;">Loading your tickets...</p>
      </div>
      
      <div id="noTicketsMessage" style="display: none; text-align: center; padding: 3rem;">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#777" stroke-width="1" style="margin-bottom: 1rem; opacity: 0.7;">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <h3 style="color: #444;">No Tickets Found</h3>
        <p style="color: #666;">You haven't purchased any tickets yet.</p>
        <button class="browse-events-btn" onclick="showSection('FindEvent')">Browse Events</button>
      </div>
      
      <div id="ticketsList" class="tickets-grid"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Show the selected tab section
    function showSection(section) {
      const sections = document.querySelectorAll('.tab-content');
      sections.forEach(sec => sec.style.display = 'none');
      document.getElementById(section).style.display = 'block';

      // Update active navigation link
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => item.classList.remove('active'));
      const activeLink = document.querySelector(`a[onclick="showSection('${section}')"]`);
      if (activeLink) activeLink.classList.add('active');
      
      // Update body class for background color control
      if (section === 'tickets') {
        document.body.classList.add('tickets-view');
      } else {
        document.body.classList.remove('tickets-view');
      }
    }

    // Search functionality for events
    document.getElementById('searchInput').addEventListener('input', function () {
      const query = this.value.toLowerCase();
      const events = document.querySelectorAll('.event-card');
      events.forEach(event => {
        const title = event.querySelector('.event-title').textContent.toLowerCase();
        event.style.display = title.includes(query) ? '' : 'none';
      });
    });

    // Set default section when the page loads
    document.addEventListener("DOMContentLoaded", function () {
      showSection('FindEvent');
    });
  </script>
  
  <!-- Google Places Autocomplete Script -->
  <script>
    // Initialize autocomplete for address input field
    function initializeAutocomplete(id) {
      try {
        var element = document.getElementById(id);
        if (!element) {
          console.error('Element with ID ' + id + ' not found');
          return;
        }
        
        if (!window.google || !window.google.maps || !window.google.maps.places) {
          console.error('Google Maps Places API not available');
          element.placeholder = 'Enter your address manually';
          return;
        }
        
        console.log('Initializing autocomplete for ' + id);
        
        var autocomplete = new google.maps.places.Autocomplete(element, { 
          types: ['geocode'],
          componentRestrictions: { country: ['us', 'ca'] } // Restrict to US, Canada- modify as needed
        });
        
        // Add a loading indicator
        if (!document.getElementById('address-loading')) {
          element.insertAdjacentHTML('afterend', '<div id="address-loading" style="display:none; position:absolute; right:10px; top:50%; transform:translateY(-50%);"><div class="spinner"></div></div>');
        }
        const loadingIndicator = document.getElementById('address-loading');
        
        // Show loading indicator when typing
        element.addEventListener('input', function() {
          if (this.value.length > 2) {
            loadingIndicator.style.display = 'block';
            // Hide after 1 second (typical API response time)
            setTimeout(() => {
              loadingIndicator.style.display = 'none';
            }, 1000);
          }
        });
        
        // Prevent form submission when pressing enter in the address field
        element.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && document.querySelector('.pac-container:visible')) {
            e.preventDefault();
          }
        });
        
        // Add place_changed listener
        google.maps.event.addListener(autocomplete, 'place_changed', function() {
          onPlaceChanged.call(this);
        });
        
        // Store the autocomplete instance on the element for future reference
        element.autocomplete = autocomplete;
        
        console.log('Autocomplete initialized successfully for ' + id);
        return autocomplete;
      } catch (error) {
        console.error('Error initializing autocomplete:', error);
        // Fallback to manual input
        element.placeholder = 'Enter your address manually';
      }
    }

    // Handle place selection
    function onPlaceChanged() {
      try {
        var place = this.getPlace();
        
        if (!place || !place.address_components) {
          console.log('No valid place selected or missing address components');
          return;
        }
        
        console.log('Place selected:', place.formatted_address);
        
        // Extract street address components
        let streetNumber = '';
        let route = '';
        
        // Map address components to the appropriate fields
        for (var i in place.address_components) {
          var component = place.address_components[i];
          for (var j in component.types) {
            var type = component.types[j];
            
            switch(type) {
              case 'street_number':
                streetNumber = component.long_name;
                break;
              case 'route':
                route = component.long_name;
                break;
              case 'locality':
                document.getElementById('city').value = component.long_name;
                break;
              case 'administrative_area_level_1':
                document.getElementById('state').value = component.long_name;
                break;
              case 'postal_code':
                document.getElementById('pincode').value = component.long_name;
                break;
            }
          }
        }
        
        // Set just the street address for address1 field (street number + route)
        const streetAddress = (streetNumber && route) ? `${streetNumber} ${route}` : 
                             (streetNumber || route || place.name || '');
        
        // If we couldn't extract a proper street address, fall back to formatted_address
        document.getElementById('address1').value = streetAddress || place.formatted_address;
        
        // Focus on the next field after selection
        document.getElementById('address2').focus();
        
        // Trigger a custom event that other scripts can listen for
        const event = new CustomEvent('addressSelected', { 
          detail: { 
            address: place.formatted_address,
            components: place.address_components
          } 
        });
        document.dispatchEvent(event);
      } catch (error) {
        console.error('Error handling place selection:', error);
      }
    }
    
    // Reinitialize autocomplete if needed
    function reinitializeAutocomplete(id) {
      const element = document.getElementById(id);
      if (element && (!element.autocomplete || !window.google || !window.google.maps)) {
        console.log('Reinitializing autocomplete for ' + id);
        loadGoogleMapsAPI();
      }
    }
    
    // Add a click handler to reinitialize if needed
    document.addEventListener('DOMContentLoaded', function() {
      const addressField = document.getElementById('address1');
      if (addressField) {
        addressField.addEventListener('click', function() {
          reinitializeAutocomplete('address1');
        });
      }
      
      // Add validation for name fields (letters only)
      const nameFields = document.querySelectorAll('#firstName, #lastName');
      nameFields.forEach(field => {
        field.addEventListener('input', function(e) {
          // Remove any non-letter characters (except spaces)
          this.value = this.value.replace(/[^A-Za-z ]/g, '');
        });
      });
      
      // Add validation for phone field (numbers only, max 10 digits)
      const phoneField = document.getElementById('phone');
      if (phoneField) {
        phoneField.addEventListener('input', function(e) {
          // Remove any non-digit characters
          this.value = this.value.replace(/\D/g, '');
          
          // Limit to 10 digits
          if (this.value.length > 10) {
            this.value = this.value.slice(0, 10);
          }
        });
      }
    });
  </script>
  
  <!-- Firebase User Profile Integration -->
  <script type="module">
    import {
      onUserStateChanged,
      getUserProfile,
      saveUserProfile,
      signOutUser
    } from './firebase.js';
    
    // Make currentUser a global variable attached to window
    window.currentUser = null;
    
    // Function to handle user state changes
    onUserStateChanged(async (user) => {
      if (!user) {
        // Not logged in, redirect to home
        window.location.href = 'index.html';
        return;
      }
      
      window.currentUser = user;
      console.log('User logged in:', user.email);
      
      // Get user profile data
      const profileData = await getUserProfile(user.uid);
      if (profileData) {
        // Populate form fields
        document.getElementById('firstName').value = profileData.firstName || '';
        document.getElementById('lastName').value = profileData.lastName || '';
        document.getElementById('phone').value = profileData.phone || '';
        document.getElementById('address1').value = profileData.address1 || '';
        document.getElementById('address2').value = profileData.address2 || '';
        document.getElementById('landmark').value = profileData.landmark || '';
        document.getElementById('city').value = profileData.city || '';
        document.getElementById('pincode').value = profileData.pincode || '';
        document.getElementById('state').value = profileData.state || '';
        
        // Update profile header
        const firstName = profileData.firstName || '';
        const lastName = profileData.lastName || '';
        
        // Set welcome message
        if (firstName || lastName) {
          document.getElementById('welcomeUserName').textContent = firstName + (lastName ? ' ' + lastName : '');
        }
        
        // Set initials
        const initials = (firstName ? firstName.charAt(0) : '') + (lastName ? lastName.charAt(0) : '');
        if (initials) {
          document.getElementById('userInitials').textContent = initials.toUpperCase();
        }
      }
    });
    
    // Handle form submission
    document.addEventListener('DOMContentLoaded', () => {
      const profileForm = document.getElementById('profileForm');
      if (profileForm) {
        profileForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (!window.currentUser) return;
          
          try {
            // Gather form data
            const profileData = {
              firstName: document.getElementById('firstName').value,
              lastName: document.getElementById('lastName').value,
              phone: document.getElementById('phone').value,
              address1: document.getElementById('address1').value,
              address2: document.getElementById('address2').value,
              landmark: document.getElementById('landmark').value,
              city: document.getElementById('city').value,
              pincode: document.getElementById('pincode').value,
              state: document.getElementById('state').value,
              updatedAt: new Date()
            };
            
            // Save to Firestore
            await saveUserProfile(window.currentUser.uid, profileData);
            
            // Show success popup
            Swal.fire({
              title: 'Profile Updated',
              text: 'Your profile information has been updated successfully!',
              icon: 'success',
              confirmButtonText: 'OK'
            });
          } catch (error) {
            console.error('Error updating profile:', error);
            Swal.fire({
              title: 'Error',
              text: 'Failed to update profile. Please try again.',
              icon: 'error',
              confirmButtonText: 'OK'
            });
          }
        });
      }
      
      // Attach sign out function to button
      const navSignOutBtn = document.getElementById('navSignOutBtn');
      if (navSignOutBtn) {
        navSignOutBtn.addEventListener('click', async () => {
          try {
            await signOutUser();
            window.location.href = 'index.html';
          } catch (error) {
            console.error('Sign out error:', error);
          }
        });
      }
    });
  </script>
  
  <script type="module" src="app.js"></script>
<!-- Event Details Popup -->
<div id="eventPopup" class="hidden">
  <button class="close-btn" onclick="closeEventPopup()">‚úñ</button>
  <div class="event-popup-content" id="eventPopUp">
    <input type="hidden" id="eventID" value="">
    <!-- Slider Container -->
    <div class="slider" id="slider">
      <button class="slider-btn prev" onclick="prevSlide()">‚ùÆ</button>
      <div class="slides">
        <img src="" alt="Event Image 1" id="eventImage1" class="slide" />
        <img src="" alt="Event Image 2" id="eventImage2" class="slide" />
        <img src="" alt="Event Image 3" id="eventImage3" class="slide" />
      </div>
      <button class="slider-btn next" onclick="nextSlide()">‚ùØ</button>
    </div>

    <h2 id="eventTitle"></h2>
    <div class="event-popup-details">
      <p id="eventDescription"></p>
      <div class="event-info-grid">
        <div class="info-item">
          <strong>Date:</strong>
          <span id="eventDate"></span>
        </div>
        <div class="info-item">
          <strong>Time:</strong>
          <span id="eventTime"></span>
        </div>
        <div class="info-item">
          <strong>Location:</strong>
          <span id="eventLocation"></span>
        </div>
      </div>
      <div class="ticket-section">
        <h3>Tickets</h3>
        <div class="ticket-types">
          <div class="ticket-type">
            <label>General Admission</label>
            <div class="ticket-price" id="generalPrice"></div>
            <div class="quantity-selector">
              <button onclick="updateQuantity('general', -1)">-</button>
              <input type="number" id="generalQuantity" value="0" min="0" readonly />
              <button onclick="updateQuantity('general', 1)">+</button>
            </div>
          </div>
          <div class="ticket-type" id="seniorTickets" style="display: none;">
            <label>Senior</label>
            <div class="ticket-price" id="seniorPrice"></div>
            <div class="quantity-selector">
              <button onclick="updateQuantity('senior', -1)">-</button>
              <input type="number" id="seniorQuantity" value="0" min="0" readonly />
              <button onclick="updateQuantity('senior', 1)">+</button>
            </div>
          </div>
          <div class="ticket-type" id="childTickets" style="display: none;">
            <label>Child</label>
            <div class="ticket-price" id="childPrice"></div>
            <div class="quantity-selector">
              <button onclick="updateQuantity('child', -1)">-</button>
              <input type="number" id="childQuantity" value="0" min="0" readonly />
              <button onclick="updateQuantity('child', 1)">+</button>
            </div>
          </div>
        </div>
        <h4>Total Price: <span id="totalPrice"></span></h4>
      </div>
      <button class="proceed-payment-btn" id="paymentBtn" onclick="checkout()">Proceed to Payment</button>
    </div>
  </div>
</div>

<!-- Feedback Modal -->
<div id="feedbackModal" class="modal">
  <div class="modal-content">
    <h2>Event Feedback</h2>
    <p id="eventTitle"></p>
    <form id="feedbackForm">
      <label>Was the event well-organized?</label>
      <div>
        <input type="radio" name="organized" value="Yes" required> Yes
        <input type="radio" name="organized" value="No"> No
      </div>

      <label>Was the venue comfortable?</label>
      <div>
        <input type="radio" name="venue" value="Yes" required> Yes
        <input type="radio" name="venue" value="No"> No
      </div>

      <label>Was the event on schedule?</label>
      <div>
        <input type="radio" name="schedule" value="Yes" required> Yes
        <input type="radio" name="schedule" value="No"> No
      </div>

      <label>Would you attend a similar event again?</label>
      <div>
        <input type="radio" name="attendAgain" value="Yes" required> Yes
        <input type="radio" name="attendAgain" value="No"> No
      </div>

      <label>Overall Rating:</label>
      <div id="starRating">
        <span class="star" data-value="1">&#9733;</span>
        <span class="star" data-value="2">&#9733;</span>
        <span class="star" data-value="3">&#9733;</span>
        <span class="star" data-value="4">&#9733;</span>
        <span class="star" data-value="5">&#9733;</span>
      </div>
      <input type="hidden" name="rating" id="ratingInput" required>

      <button type="submit" class="feed2btn">Submit Feedback</button>
    </form>
  </div>
</div>


<script>
  import { updateTickets } from './firebase.js';

  import { checkout, submitPayment } from './app.js';


</script>

  <!-- Event Popup Functionality Script -->
  <script type="module">
    import { showEventPopup } from './app.js';
    // Expose the function so event cards can trigger the popup
    window.showEventPopup = showEventPopup;

    window.closeEventPopup = function() {
      // If your page doesn't have an element with id 'content', this check avoids errors.
      const content = document.getElementById('content');
      if (content) {
        content.classList.remove('active');
      }
      const popup = document.getElementById('eventPopup');
      popup.classList.add('hidden');
      document.body.classList.remove('popup-open');
    }
  </script>

<!-- Tickets Tab Script -->
<script type="module">
  import { getUserTickets, saveFeedback, hasUserSubmittedFeedback } from './firebase.js';
  import { getAuth } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
  import { generateQRCode } from './email.js';
  
  // Show Feedback Modal
  async function sendFeedback(ticket) {
    // Check if user is logged in
    if (!window.currentUser) {
      showProfileNotUpdated("Please log in to submit feedback.");
      return;
    }

    // Get event ID from ticket
    const eventId = ticket.eventDetails?.id || ticket.eventId;
    if (!eventId) {
      showProfileNotUpdated("Error: Event ID not found.");
      return;
    }

    // Check if user has already submitted feedback
    try {
      const hasSubmitted = await hasUserSubmittedFeedback(window.currentUser.uid, eventId);
      if (hasSubmitted) {
        showProfileNotUpdated("You have already submitted feedback for this event.");
        return;
      }
    } catch (error) {
      console.error("Error checking existing feedback:", error);
      showProfileNotUpdated("Error checking feedback status. Please try again.");
      return;
    }

    // If we get here, user hasn't submitted feedback yet - show the form
    document.getElementById('feedbackModal').style.display = 'flex';
    document.getElementById('eventTitle').innerText = `Feedback for ${ticket.eventDetails.title}`;

    // Clear previous selection
    document.querySelectorAll('input[name="organized"], input[name="venue"], input[name="schedule"], input[name="attendAgain"]').forEach(input => input.checked = false);
    document.getElementById('ratingInput').value = '';
    document.querySelectorAll('.star').forEach(star => star.classList.remove('selected'));

    // Handle star rating
    document.querySelectorAll('.star').forEach(star => {
      star.addEventListener('click', function() {
        let value = this.getAttribute('data-value');
        document.getElementById('ratingInput').value = value;
        document.querySelectorAll('.star').forEach(s => s.classList.remove('selected'));
        for (let i = 0; i < value; i++) {
          document.querySelectorAll('.star')[i].classList.add('selected');
        }
      });
    });

    // Submit Feedback
    document.getElementById('feedbackForm').onsubmit = async function(event) {
      event.preventDefault();

      let feedbackData = {
        eventTitle: ticket.eventDetails.title,
        organized: document.querySelector('input[name="organized"]:checked').value,
        venue: document.querySelector('input[name="venue"]:checked').value,
        schedule: document.querySelector('input[name="schedule"]:checked').value,
        attendAgain: document.querySelector('input[name="attendAgain"]:checked').value,
        rating: document.getElementById('ratingInput').value,
        userId: window.currentUser.uid,
        eventId: eventId
      };
      
      // Add debugging logs
      console.log("Ticket data:", JSON.stringify(ticket, null, 2));
      console.log("Feedback data to save:", feedbackData);

      try {
        // Save feedback to Firestore
        await saveFeedback(feedbackData);
        showSendFeedback("Thank you for your feedback!");
      } catch (error) {
        console.error("Error submitting feedback:", error);
        showProfileNotUpdated("Error submitting feedback. Please try again.");
      }

      closeFeedbackModal();
    };
  }

  function closeFeedbackModal() {
    document.getElementById('feedbackModal').style.display = 'none';
  }  
  
  // Close the modal when clicking outside of it
  window.onclick = function(event) {
    const modal = document.getElementById('feedbackModal');
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  };

  // Improved ticket loading function - more efficient and with better feedback
  async function loadUserTickets() {
    console.log('Loading tickets...');
    
    // Use the global currentUser instead of reimporting auth
    if (!window.currentUser) {
      console.error('User not logged in');
      document.getElementById('ticketsLoading').style.display = 'none';
      document.getElementById('noTicketsMessage').style.display = 'block';
      return;
    }
    
    // Show loading indicator
    document.getElementById('ticketsLoading').style.display = 'block';
    document.getElementById('noTicketsMessage').style.display = 'none';
    document.getElementById('ticketsList').innerHTML = '';
    
    try {
      console.time('Ticket loading time');
      // Fetch tickets with the current user ID
      const tickets = await getUserTickets(window.currentUser.uid);
      console.timeEnd('Ticket loading time');
      console.log(`Loaded ${tickets.length} tickets`);
      
      // Hide loading indicator
      document.getElementById('ticketsLoading').style.display = 'none';
      
      if (tickets.length === 0) {
        // Show no tickets message
        document.getElementById('noTicketsMessage').style.display = 'block';
      } else {
        // Render tickets in batches for better performance
        const ticketsListEl = document.getElementById('ticketsList');
        
        // Process in batches of 5 for smoother rendering
        const batchSize = 5;
        for (let i = 0; i < tickets.length; i += batchSize) {
          const batch = tickets.slice(i, i + batchSize);
          
          // Use setTimeout to allow UI to update between batches
          setTimeout(() => {
            batch.forEach(async (ticket) => {
              const ticketCard = await createTicketCard(ticket);
              ticketsListEl.appendChild(ticketCard);
            });
          }, 0);
        }
      }
    } catch (error) {
      console.error('Error loading tickets:', error);
      document.getElementById('ticketsLoading').style.display = 'none';
      document.getElementById('noTicketsMessage').style.display = 'block';
      document.getElementById('noTicketsMessage').innerHTML = `
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#777" stroke-width="1" style="margin-bottom: 1rem; opacity: 0.7;">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <h3 style="color: #444;">Error Loading Tickets</h3>
        <p style="color: #666;">Please try again later.</p>
        <button class="browse-events-btn" onclick="showSection('FindEvent')">Browse Events</button>
      `;
    }
  }
  
  // Expose the function to global scope
  window.loadUserTickets = loadUserTickets;
  window.sendFeedback = sendFeedback;
  
  // Automatically load tickets when the section is shown
  document.addEventListener('DOMContentLoaded', () => {
    // Add click event to the tickets tab link
    const ticketsLink = document.querySelector('a[onclick="showSection(\'tickets\')"]');
    if (ticketsLink) {
      // Remove the click event listener since showSection will handle loading
      ticketsLink.removeEventListener('click', loadUserTickets);
    }
    
    // Modify the showSection function to auto-load tickets when that section is shown
    const originalShowSection = window.showSection;
    window.showSection = function(section) {
      originalShowSection(section);
      if (section === 'tickets') {
        // Clear existing tickets before loading new ones
        document.getElementById('ticketsList').innerHTML = '';
        console.log('Tickets section shown, loading tickets...');
        loadUserTickets();
      }
    };
  });

  // Create HTML for a ticket card
  async function createTicketCard(ticket) {
    // Format date for display
    const eventDate = new Date(ticket.eventDetails.date); // Event date
    const today = new Date(); // Current date
    
    // Create ticket element
    const ticketEl = document.createElement('div');
    ticketEl.className = 'ticket-card';

    // Generate QR code for this ticket
    let qrCodeDataURL;
    try {
      qrCodeDataURL = await generateQRCode(ticket);
    } catch (error) {
      console.error('Error generating QR code:', error);
      qrCodeDataURL = 'https://via.placeholder.com/150?text=Ticket';
    }

    // Check if there was a discount applied
    const hasDiscount = ticket.discountApplied;
    const discountAmount = hasDiscount ? ticket.discountAmount : 0;

    ticketEl.innerHTML = `
      <img src="${ticket.eventDetails.imageUrl || 'images/event-placeholder.jpg'}" alt="${ticket.eventDetails.title}" class="ticket-image">
      <div class="ticket-content">
        <h3 class="ticket-title">${ticket.eventDetails.title}</h3>
        <div class="ticket-info">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          <span>${ticket.eventDetails.date}</span>
        </div>
        <div class="ticket-info">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <span>${ticket.eventDetails.time}</span>
        </div>
        <div class="ticket-info">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M21 10c0 6-9 13-9 13S3 16 3 10a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          <span>${ticket.eventDetails.location}</span>
        </div>
        <div class="ticket-details">
          ${ticket.tickets.general > 0 ? 
            `<div class="ticket-quantity">
              <span>General Admission</span>
              <span>x${ticket.tickets.general}</span>
            </div>` : ''
          }
          ${ticket.tickets.senior > 0 ? 
            `<div class="ticket-quantity">
              <span>Senior</span>
              <span>x${ticket.tickets.senior}</span>
            </div>` : ''
          }
          ${ticket.tickets.child > 0 ? 
            `<div class="ticket-quantity">
              <span>Child</span>
              <span>x${ticket.tickets.child}</span>
            </div>` : ''
          }
          ${hasDiscount ? 
            `<div class="ticket-price">
              <span class="original-price">$${ticket.originalPrice}</span>
              <span class="discounted-price">$${ticket.finalPrice}</span>
              <span class="discount-badge">You saved $${discountAmount}</span>
            </div>` :
            `<div class="ticket-price">$${ticket.finalPrice}</div>`
          }
        </div>
        <div class="ticket-qr-code">
          <h4>Your Ticket QR Code</h4>
          <img src="${qrCodeDataURL}" alt="Ticket QR Code" class="qr-code-image">
          <p class="qr-instructions">Present this QR code at the event entrance</p>
        </div>
      </div>
    `;

    // Only add the feedback button if the event date has passed
    if (eventDate < today) {
      const feedbackButton = document.createElement('button');
      feedbackButton.className = 'feedback-button';
      feedbackButton.innerText = 'Send Feedback';
      feedbackButton.addEventListener('click', () => sendFeedback(ticket));
      ticketEl.querySelector('.ticket-content').appendChild(feedbackButton);
    }

    return ticketEl;
  }
  
  // Add helper functions for alerts
  function showSendFeedback(message) {
    Swal.fire({
      icon: 'success',
      title: 'Feedback Sent',
      text: message || 'Thank you for sending feedback.',
      confirmButtonText: 'OK'
    });
  }

  function showProfileUpdate(message) {
    Swal.fire({
      title: 'Profile Updated',
      text: message || 'Your profile has been updated.',
      confirmButtonText: 'OK'
    });
  }

  function showProfileNotUpdated(message) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: message || 'Please make sure all fields are filled out correctly.',
      confirmButtonText: 'OK'
    });
  }
</script>
</body>
</html>